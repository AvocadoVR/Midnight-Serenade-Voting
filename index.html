<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Midnight Serenade Voting</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Use Inter font -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0d1117; /* Dark background */
            color: #c9d1d9; /* Light text */
        }
        .card {
            background-color: #161b22;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.5);
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center justify-center p-4">

    <!-- Main Container -->
    <div id="app" class="w-full max-w-2xl space-y-8">
        <h1 class="text-4xl font-extrabold text-center text-blue-400">Midnight Serenade Voting</h1>
        <p class="text-center text-sm text-gray-400" id="user-info">Authenticating...</p>
        
        <!-- Vote Casting Area -->
        <div id="voting-area" class="card p-6 rounded-xl hidden">
            <h2 class="text-2xl font-semibold mb-4 text-white">Cast Your Vote</h2>
            <div id="vote-options" class="space-y-3">
                <!-- Vote buttons will be dynamically inserted here -->
            </div>
            <p id="vote-message" class="mt-4 text-center font-medium"></p>
        </div>

        <!-- Results Display -->
        <div id="results-area" class="card p-6 rounded-xl hidden">
            <h2 class="text-2xl font-semibold mb-4 text-white">Current Results</h2>
            <div id="results-list" class="space-y-3">
                <!-- Results will be dynamically inserted here -->
            </div>
        </div>

        <!-- Admin Panel Section -->
        <div id="admin-panel" class="card p-6 rounded-xl border border-gray-700">
            <h2 class="text-xl font-semibold mb-4 text-yellow-400">Admin Control</h2>
            
            <div id="admin-gate">
                <p class="mb-2 text-sm text-gray-400">Enter Admin Password to gain control:</p>
                <div class="flex space-x-2">
                    <input type="password" id="admin-password-input" placeholder="Password"
                           class="flex-grow p-2 rounded-lg bg-gray-800 border border-gray-700 focus:ring-blue-500 focus:border-blue-500 text-white">
                    <button id="admin-login-button" 
                            class="px-4 py-2 bg-yellow-600 hover:bg-yellow-700 text-white font-medium rounded-lg transition duration-150">
                        Authenticate
                    </button>
                </div>
                <p id="admin-gate-message" class="mt-2 text-sm text-center"></p>
            </div>

            <div id="admin-tools" class="hidden space-y-4">
                <p class="text-green-500 font-bold">ðŸŽ‰ Admin Access Granted! (User ID: <span id="admin-uid"></span>)</p>
                <button id="reset-votes-button" 
                        class="w-full px-4 py-2 bg-red-600 hover:bg-red-700 text-white font-bold rounded-lg transition duration-150">
                    Reset All Votes (Admin Only)
                </button>
            </div>
        </div>

        <!-- Error/Loading -->
        <div id="loader" class="text-center text-lg mt-8">Loading Firebase...</div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, signInAnonymously, signInWithCustomToken, 
            onAuthStateChanged 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, doc, setDoc, updateDoc, onSnapshot, 
            collection, getDocs, writeBatch, increment 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global Variable Definitions (MANDATORY)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = {
            apiKey: "AIzaSyCQQjVBo9co8w0GzGGzbw_tG7s51y34A6I",
            authDomain: "midnight-voting-3b1bb.firebaseapp.com",
            projectId: "midnight-voting-3b1bb",
            storageBucket: "midnight-voting-3b1bb.firebasestorage.app",
            messagingSenderId: "268153243141",
            appId: "1:268153243141:web:717d164de36083c4707e6c",
            measurementId: "G-RXQ25RHNT1"
        };
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // --- Configuration ---
        const ADMIN_PASSWORD = "Admin";
        const VOTE_OPTIONS = ["Option A: Serene Lake", "Option B: Haunted Forest", "Option C: Crystal Caves"];
        
        // --- Firebase Initialization ---
        setLogLevel('Debug');
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // --- DOM Elements ---
        const loaderEl = document.getElementById('loader');
        const userInfoEl = document.getElementById('user-info');
        const votingAreaEl = document.getElementById('voting-area');
        const resultsAreaEl = document.getElementById('results-area');
        const voteOptionsEl = document.getElementById('vote-options');
        const resultsListEl = document.getElementById('results-list');
        const voteMessageEl = document.getElementById('vote-message');
        const adminGateEl = document.getElementById('admin-gate');
        const adminToolsEl = document.getElementById('admin-tools');
        const adminPasswordInput = document.getElementById('admin-password-input');
        const adminLoginButton = document.getElementById('admin-login-button');
        const adminGateMessageEl = document.getElementById('admin-gate-message');
        const resetVotesButton = document.getElementById('reset-votes-button');
        const adminUidEl = document.getElementById('admin-uid');

        let isAuthReady = false;
        let currentUserId = null;
        let isAdminStatus = false;

        // --- Firestore Paths ---
        const PUBLIC_VOTES_PATH = `artifacts/${appId}/public/data/votes`;
        const getUserAdminConfigPath = (uid) => 
            `artifacts/${appId}/users/${uid}/admin_config/status`;

        // --- 1. Authentication Setup ---
        async function authenticateUser() {
            try {
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Firebase Auth Error:", error);
                userInfoEl.textContent = "Error: Authentication failed.";
            }
        }

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUserId = user.uid;
                userInfoEl.textContent = `User ID: ${user.uid}`;
                
                // Once authenticated, start listening for Admin status and Votes
                isAuthReady = true;
                loaderEl.classList.add('hidden');
                votingAreaEl.classList.remove('hidden');
                resultsAreaEl.classList.remove('hidden');

                listenForAdminStatus(user.uid);
                listenForVotes();
                renderVoteOptions();

            } else {
                userInfoEl.textContent = "Not signed in.";
                // Attempt to sign in if not already
                if (!isAuthReady) {
                    authenticateUser();
                }
            }
        });


        // --- 2. Admin Logic ---

        function listenForAdminStatus(uid) {
            const adminDocRef = doc(db, getUserAdminConfigPath(uid));
            
            onSnapshot(adminDocRef, (docSnap) => {
                isAdminStatus = docSnap.exists() && docSnap.data().isAdmin === true;
                renderAdminUI();
            }, (error) => {
                console.error("Error listening to admin status:", error);
                // If there's a read error, default to not admin
                isAdminStatus = false;
                renderAdminUI();
            });
        }

        function renderAdminUI() {
            adminUidEl.textContent = currentUserId;
            if (isAdminStatus) {
                adminGateEl.classList.add('hidden');
                adminToolsEl.classList.remove('hidden');
            } else {
                adminGateEl.classList.remove('hidden');
                adminToolsEl.classList.add('hidden');
            }
        }

        adminLoginButton.addEventListener('click', async () => {
            adminGateMessageEl.textContent = '';
            const password = adminPasswordInput.value;

            if (password === ADMIN_PASSWORD) {
                try {
                    // Write the flag document to gain admin access via security rules
                    const adminDocRef = doc(db, getUserAdminConfigPath(currentUserId));
                    await setDoc(adminDocRef, { isAdmin: true });

                    adminGateMessageEl.textContent = 'Successfully authenticated! Access granted.';
                    adminGateMessageEl.classList.remove('text-red-500');
                    adminGateMessageEl.classList.add('text-green-500');
                    adminPasswordInput.value = '';

                } catch (e) {
                    console.error("Error setting admin status:", e);
                    adminGateMessageEl.textContent = 'Authentication failed due to a database error.';
                    adminGateMessageEl.classList.add('text-red-500');
                }
            } else {
                adminGateMessageEl.textContent = 'Incorrect password.';
                adminGateMessageEl.classList.add('text-red-500');
            }
        });


        // --- 3. Voting & Results Logic ---

        function renderVoteOptions() {
            voteOptionsEl.innerHTML = VOTE_OPTIONS.map((option, index) => {
                const optionId = `option_${String.fromCharCode(65 + index)}`;
                return `
                    <button data-option-id="${optionId}"
                            class="vote-button w-full px-4 py-3 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-lg transition duration-150">
                        Vote for ${option}
                    </button>
                `;
            }).join('');
            
            document.querySelectorAll('.vote-button').forEach(button => {
                button.addEventListener('click', handleVote);
            });
        }

        async function handleVote(event) {
            if (!currentUserId) {
                voteMessageEl.textContent = 'Please wait for authentication to complete.';
                voteMessageEl.className = 'mt-4 text-center font-medium text-yellow-500';
                return;
            }

            const optionId = event.target.dataset.optionId;
            const voteDocRef = doc(db, PUBLIC_VOTES_PATH, optionId);

            try {
                await updateDoc(voteDocRef, {
                    count: increment(1)
                });
                voteMessageEl.textContent = 'Your vote has been cast successfully!';
                voteMessageEl.className = 'mt-4 text-center font-medium text-green-500';
                
            } catch (error) {
                // If the document doesn't exist, create it (admin rules allow read only for users, 
                // but for initial setup, we assume it exists or use an admin to create defaults)
                
                // For a robust user experience, we can try to set the initial value if update fails 
                // (e.g., if the document is missing)
                
                if (error.code === 'not-found') {
                    // If not found, try to set it to 1
                    try {
                        await setDoc(voteDocRef, { count: 1 });
                        voteMessageEl.textContent = 'Your vote has been cast successfully (initial vote)!';
                        voteMessageEl.className = 'mt-4 text-center font-medium text-green-500';
                    } catch (e) {
                        console.error("Initial Vote Error:", e);
                        voteMessageEl.textContent = 'Error casting vote (Permissions denied or initialization needed).';
                        voteMessageEl.className = 'mt-4 text-center font-medium text-red-500';
                    }
                } else {
                    console.error("Error casting vote:", error);
                    voteMessageEl.textContent = 'Error casting vote: Permission denied.';
                    voteMessageEl.className = 'mt-4 text-center font-medium text-red-500';
                }
            }
        }


        let currentVotes = {};

        function listenForVotes() {
            const votesCollectionRef = collection(db, PUBLIC_VOTES_PATH);
            
            onSnapshot(votesCollectionRef, (snapshot) => {
                let totalVotes = 0;
                snapshot.forEach(doc => {
                    const data = doc.data();
                    currentVotes[doc.id] = data.count || 0;
                    totalVotes += (data.count || 0);
                });
                renderResults(totalVotes);
            }, (error) => {
                console.error("Error fetching votes:", error);
                resultsListEl.innerHTML = '<p class="text-red-500">Error loading results.</p>';
            });
        }

        function renderResults(totalVotes) {
            let html = '';
            
            VOTE_OPTIONS.forEach((optionTitle, index) => {
                const optionId = `option_${String.fromCharCode(65 + index)}`;
                const count = currentVotes[optionId] || 0;
                const percentage = totalVotes > 0 ? ((count / totalVotes) * 100).toFixed(1) : 0;
                
                html += `
                    <div>
                        <div class="flex justify-between mb-1">
                            <span class="font-medium">${optionTitle}</span>
                            <span class="font-bold text-blue-300">${count} Votes (${percentage}%)</span>
                        </div>
                        <div class="w-full bg-gray-700 rounded-full h-2.5">
                            <div class="bg-blue-500 h-2.5 rounded-full" style="width: ${percentage}%"></div>
                        </div>
                    </div>
                `;
            });
            
            html += `<p class="mt-4 pt-2 border-t border-gray-700 text-lg font-bold text-center text-white">Total Votes: ${totalVotes}</p>`;
            resultsListEl.innerHTML = html;
        }


        // --- 4. Admin Reset Function ---

        resetVotesButton.addEventListener('click', async () => {
            if (!isAdminStatus) {
                alert("Action denied. You are not authenticated as an Admin.");
                return;
            }

            const confirmMessage = "Are you absolutely sure you want to reset ALL votes? This action cannot be undone.";
            if (confirm(confirmMessage)) {
                try {
                    // Fetch all vote documents
                    const votesRef = collection(db, PUBLIC_VOTES_PATH);
                    const snapshot = await getDocs(votesRef);
                    const batch = writeBatch(db);

                    snapshot.forEach((docSnap) => {
                        // Set the count back to 0 (or you could delete the doc)
                        batch.set(docSnap.ref, { count: 0 }); 
                    });

                    await batch.commit();

                    alert("All votes have been successfully reset to 0.");

                } catch (error) {
                    console.error("Admin Vote Reset Error:", error);
                    alert("Failed to reset votes. Check console for details.");
                }
            }
        });

        // Start the authentication process
        authenticateUser();

    </script>
</body>
</html>
